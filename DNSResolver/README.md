# Дизайн: Обработка флага TC и переход на TCP в итеративном DNS-резолвере

## 1. Контекст

DNS-протокол по умолчанию использует **UDP** для запросов и ответов из-за его низкой накладной стоимости. Однако спецификация RFC 1035 ограничивает размер UDP-пакета **512 байтами** при отсутствии расширения EDNS0 (которое в данном проекте не используется для соответствия классическому протоколу).

Когда ответ превышает этот лимит, DNS-сервер **обрывает пакет**, устанавливает флаг **TC (Truncated)** в заголовке и отправляет усечённую версию. Это сигнал клиенту: «полный ответ можно получить только через TCP».

## 2. Алгоритм обработки

Резолвер реализует следующую логику:

### Шаг 1: Отправка запроса по UDP
- Создаётся UDP-сокет с таймаутом 5 секунд.
- Запрос формируется в соответствии с правилами:
    - Идентификатор (ID),
    - Флаги (RD=0 для итеративного режима),
    - Вопрос (QNAME, QTYPE=A/AAAA, QCLASS=IN).

### Шаг 2: Анализ UDP-ответа
После получения ответа:
- Проверяется совпадение **ID** (защита от подделки).
- Анализируются флаги в байтах 2–3 заголовка:
  ```cpp
  uint16_t flags = (response[2] << 8) | response[3];
  bool tc_set = (flags & 0x0200) != 0; // бит 9
  ```
- Если `tc_set == true`, резолвер **немедленно закрывает UDP-сокет** и переходит к Шагу 3.

### Шаг 3: Установка TCP-соединения
- Создаётся TCP-сокет с таймаутами на чтение/запись (10 сек).
- Выполняется `connect()` к тому же IP-адресу и порту 53.
- При неудаче — запрос считается проваленным.

### Шаг 4: Отправка DNS-пакета по TCP
- Перед DNS-запросом добавляется **2-байтовый префикс длины** (big-endian):
  ```cpp
  uint16_t len = htons(query.size());
  send(tcp_sock, &len, 2, 0);
  send(tcp_sock, query.data(), query.size(), 0);
  ```

### Шаг 5: Приём полного ответа
- Сначала читаются 2 байта — длина полезной нагрузки (`N`).
- Затем читаются ровно `N` байт DNS-ответа.
- Ответ парсится **так же, как UDP-ответ** (единая логика разбора).

### Шаг 6: Продолжение разрешения
- Если ответ содержит **Answer section** — возвращаются IP-адреса.
- Если ответ содержит **делегацию (NS)** — резолвер продолжает итерации с новыми серверами.

## 3. Обработка ошибок

- **Таймаут TCP-соединения** → пропуск сервера, попытка следующего.
- **Неверная длина пакета** (`N > 65535`) → отбрасывание ответа.
- **Несовпадение ID в TCP-ответе** → игнорирование (защита от атак).

## 4. Тестирование

Переход на TCP проверяется на доменах с большим количеством записей:
- `amazon.com` (много A/AAAA),
- `gmail.com` (много TXT/MX).

В отладочном режиме (`-d`) выводится сообщение:
```
[DEBUG] TC=1 → switching to TCP for 192.0.2.1
```

## 5. Заключение

Реализация корректной обработки флага TC обеспечивает **полную совместимость с DNS-стандартами** и позволяет разрешать **любые домены**, независимо от размера их DNS-записей. Это критически важно для надёжности итеративного резолвера в реальных сетевых условиях.
